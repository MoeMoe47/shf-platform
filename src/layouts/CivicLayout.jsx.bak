// src/layouts/CivicLayout.jsx
import React from "react";
import { Outlet, Link } from "react-router-dom";
import CivicHeader from "@/components/civic/CivicHeader.jsx";
import CivicSidebar from "@/components/civic/CivicSidebar.jsx";
import { useRewards } from "@/hooks/useRewards.js";
import { ToastsProvider } from "@/context/Toasts.jsx";
import { migrateBadgesInPlace } from "@/shared/rewards/shim.js";
import CelebrationLayer from "@/components/rewards/CelebrationLayer.jsx"; // overlay for confetti/pulses

function RewardsChipHeader() {
  const { points } = useRewards();
  return (
    <Link
      to="/rewards"
      className="sh-chip is-ghost"
      title="Open Rewards Wallet"
      style={{ display: "inline-flex", alignItems: "center", gap: 6 }}
      aria-label={`Open Rewards Wallet. You have ${points} points.`}
    >
      <span aria-hidden>üèÖ</span>
      <span>{points} pts</span>
    </Link>
  );
}

export default function CivicLayout() {
  const rewards = useRewards();

  // Normalize any legacy badge ids once on mount
  React.useEffect(() => {
    migrateBadgesInPlace(() => rewards);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <ToastsProvider>
      <div className="crb-root" data-app="civic">
        <a className="crb-skip" href="#civ-main">Skip to main content</a>

        <header className="crb-header">
          <CivicHeader />
          <div className="crb-headerSpacer" />
          <RewardsChipHeader />
        </header>

        <div className="crb-body">
          <aside className="crb-sidebar" aria-label="Primary">
            <CivicSidebar />
          </aside>

          <main id="civ-main" className="crb-main" role="main" aria-live="polite">
            <Outlet />
          </main>
        </div>

        {/* Overlay goes last so it sits above everything */}
        <CelebrationLayer />
      </div>
    </ToastsProvider>
  );
}
