import React from "react";
import { matchPrograms, estimateReimbursement } from "@/shared/employer/eligibility.js";
import { salesLeadSync } from "@/shared/employer/salesBridge.js";

export default function FundingFinder() {
  const [state] = React.useState("OH");
  const [pathway, setPathway] = React.useState("tech");
  const [wage, setWage] = React.useState(16);
  const [hours, setHours] = React.useState(180);

  const programs = React.useMemo(() => matchPrograms({
    state, pathway, plannedHours: hours, isW2: true
  }), [state, pathway, hours]);

  React.useEffect(() => {
    if (programs.length) {
      salesLeadSync({
        kind: "employer_interest",
        state, pathway, wage, hours,
        programs: programs.map(p => p.id),
        ts: Date.now()
      });
    }
  }, [state, pathway, wage, hours, programs]);

  return (
    <div className="page pad">
      <h1>Funding Finder</h1>
      <div className="grid">
        <label>Pathway
          <select value={pathway} onChange={e => setPathway(e.target.value)}>
            <option value="tech">Tech</option>
            <option value="manufacturing">Manufacturing</option>
            <option value="health">Health</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label>Wage ($/hr)
          <input type="number" value={wage} min={0} step="0.25" onChange={e => setWage(+e.target.value || 0)} />
        </label>
        <label>Hours
          <input type="number" value={hours} min={0} step="1" onChange={e => setHours(+e.target.value || 0)} />
        </label>
      </div>

      <div className="card">
        <h3>Eligible Programs (Ohio)</h3>
        {!programs.length && <p>No matches yet — try Tech or increase hours.</p>}
        {programs.map(p => {
          const est = estimateReimbursement({ program: p, wage, hours });
          const pct = Math.round((p.reimbursementPercent || 0) * 100);
          const capHit = p.maxPerIntern && est >= p.maxPerIntern;
          return (
            <div key={p.id} className="prog-card" style={{ padding: "10px 0", borderTop: "1px solid var(--wash-2, #eee)"}}>
              <div className="prog-title"><strong>{p.name}</strong></div>
              <div className="prog-line">Rate: {pct ? `${pct}%` : "Training support (non-wage)"}</div>
              {p.maxPerIntern ? <div className="prog-line">Cap per intern: ${p.maxPerIntern.toLocaleString()}</div> : null}
              {pct > 0 && (
                <div className="prog-line">
                  Est. payout: <strong>${est.toLocaleString()}</strong>
                  {capHit && <span className="small" style={{ marginLeft: 8 }}>• cap reached</span>}
                </div>
              )}
              {p.notes && <div className="prog-line small muted">{p.notes}</div>}
              <div style={{ marginTop: 8 }}>
                <button
                  className="btn"
                  onClick={() => salesLeadSync({
                    kind: "start_claim",
                    programId: p.id,
                    state, pathway, wage, hours,
                    ts: Date.now()
                  })}
                >
                  Start claim →
                </button>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
